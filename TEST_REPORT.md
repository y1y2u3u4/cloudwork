# CloudWork æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ

**æµ‹è¯•æ—¶é—´**: 2026-01-19
**æµ‹è¯•ç¯å¢ƒ**: VPS (Python 3.9+)
**æµ‹è¯•ç»“æœ**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## 1. ä¼šè¯ç®¡ç†æµ‹è¯• (SessionManager)

### æµ‹è¯•è¦†ç›–

| åŠŸèƒ½ | çŠ¶æ€ | æè¿° |
|------|------|------|
| åˆ›å»ºç”¨æˆ·æ•°æ® | âœ… | è‡ªåŠ¨åˆ›å»ºç”¨æˆ·é»˜è®¤é…ç½® |
| åˆ›å»ºä¼šè¯ | âœ… | æ”¯æŒè‡ªå®šä¹‰åç§°å’Œé¡¹ç›® |
| è·å–æ´»è·ƒä¼šè¯ | âœ… | å¿«é€Ÿè·å–ç”¨æˆ·å½“å‰ä¼šè¯ |
| æ›´æ–°ä¼šè¯ | âœ… | æ›´æ–°åç§°ã€æ—¶é—´ã€è®¡æ•° |
| å¤šä¼šè¯ç®¡ç† | âœ… | åŒæ—¶ç®¡ç†å¤šä¸ªä¼šè¯ |
| ä¼šè¯å½’æ¡£ | âœ… | å½’æ¡£ä¸æ´»è·ƒçš„ä¼šè¯ |
| ä¼šè¯æ¢å¤ | âœ… | æ¢å¤å·²å½’æ¡£ä¼šè¯ |
| åˆ é™¤ä¼šè¯ | âœ… | æ°¸ä¹…åˆ é™¤ä¼šè¯ |
| ç”¨æˆ·è®¾ç½® | âœ… | æ¨¡å‹ã€æ‰§è¡Œæ¨¡å¼ã€é¡¹ç›® |
| æ•°æ®æŒä¹…åŒ– | âœ… | JSON æ–‡ä»¶å­˜å‚¨ |
| æ•°æ®é‡è½½ | âœ… | å¯åŠ¨æ—¶æ¢å¤çŠ¶æ€ |
| æ¶ˆæ¯æ˜ å°„ | âœ… | message_id â†’ session_id |
| ä¸´æ—¶ä¼šè¯ ID | âœ… | pending_ å¼€å¤´çš„ä¸´æ—¶ ID |

### å…³é”®éªŒè¯

```python
# ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
ç”¨æˆ· A åˆ›å»ºä¼šè¯ â†’ å‘é€æ¶ˆæ¯ â†’ æ›´æ–°æ—¶é—´ â†’ 30åˆ†é’Ÿæ— æ´»åŠ¨ â†’ è‡ªåŠ¨å½’æ¡£
ç”¨æˆ· B åˆ›å»ºä¼šè¯ â†’ ç‹¬ç«‹ç®¡ç† â†’ äº’ä¸å½±å“

# æ•°æ®ä¸€è‡´æ€§
å†…å­˜çŠ¶æ€ â†â†’ sessions.json
é‡å¯åå®Œæ•´æ¢å¤çŠ¶æ€
```

### æµ‹è¯•ä»£ç ç¤ºä¾‹

```python
# åˆ›å»ºä¼šè¯
session = manager.create_session(
    user_id=123456789,
    session_id="test_session_001",
    name="æµ‹è¯•ä¼šè¯"
)

# æ›´æ–°ä¼šè¯
manager.update_session(user_id, session_id, name="æ–°åç§°")

# å½’æ¡£ä¼šè¯
manager.archive_session(user_id, session_id)

# æ¢å¤ä¼šè¯
manager.unarchive_session(user_id, session_id)
```

---

## 2. Claude æ‰§è¡Œå™¨æµ‹è¯• (ClaudeExecutor)

### æµ‹è¯•è¦†ç›–

| åŠŸèƒ½ | çŠ¶æ€ | æè¿° |
|------|------|------|
| é¡¹ç›®å‘ç° | âœ… | è‡ªåŠ¨æ‰«æ workspace ç›®å½• |
| è·å–é¡¹ç›®ç›®å½• | âœ… | æ”¯æŒ default å’Œè‡ªå®šä¹‰é¡¹ç›® |
| ç¯å¢ƒå˜é‡æ„å»º | âœ… | ANTHROPIC_API_KEY ç­‰ |
| UUID éªŒè¯ | âœ… | åŒºåˆ†çœŸå® session_id å’Œ pending |
| å‘½ä»¤æ„å»º - æ–°ä¼šè¯ | âœ… | `claude -p prompt` |
| å‘½ä»¤æ„å»º - æ¢å¤ä¼šè¯ | âœ… | `claude --resume <uuid>` |
| å‘½ä»¤æ„å»º - auto æ¨¡å¼ | âœ… | `--dangerously-skip-permissions` |
| å‘½ä»¤æ„å»º - plan æ¨¡å¼ | âœ… | `--permission-mode plan` |
| æ¨¡å‹é€‰æ‹© | âœ… | sonnet / opus / haiku |

### Claude CLI å‘½ä»¤ç¤ºä¾‹

#### 1. æ–°ä¼šè¯ (auto æ¨¡å¼)
```bash
unbuffer claude \
  -p "åˆ›å»ºä¸€ä¸ª Flask API" \
  --model sonnet \
  --output-format stream-json \
  --verbose \
  --dangerously-skip-permissions
```

#### 2. æ¢å¤ä¼šè¯
```bash
unbuffer claude \
  --resume 550e8400-e29b-41d4-a716-446655440000 \
  -p "æ·»åŠ è®¤è¯åŠŸèƒ½" \
  --model opus \
  --output-format stream-json \
  --verbose \
  --dangerously-skip-permissions
```

#### 3. Plan æ¨¡å¼
```bash
unbuffer claude \
  -p "é‡æ„æ•´ä¸ªé¡¹ç›®" \
  --model sonnet \
  --output-format stream-json \
  --verbose \
  --permission-mode plan
```

### å‘½ä»¤æ„å»ºé€»è¾‘

```python
# æ ¸å¿ƒé€»è¾‘
if is_valid_uuid(session_id) and not session_id.startswith("pending_"):
    cmd = ['claude', '--resume', session_id, ...]
else:
    cmd = ['claude', '-p', prompt, ...]

if execution_mode == "plan":
    cmd.append('--permission-mode plan')
else:
    cmd.append('--dangerously-skip-permissions')
```

---

## 3. æ•°æ®ç»“æ„æµ‹è¯•

### Session æ•°æ®ç±»

```python
@dataclass
class Session:
    id: str                      # ä¼šè¯ ID
    name: str                    # äººç±»å¯è¯»åç§°
    created_at: str              # ISO æ ¼å¼æ—¶é—´
    last_active: str             # æœ€åæ´»è·ƒæ—¶é—´
    message_count: int = 0       # æ¶ˆæ¯è®¡æ•°
    archived: bool = False       # æ˜¯å¦å½’æ¡£
    project: Optional[str] = None # é¡¹ç›®åç§°
```

**åºåˆ—åŒ–æµ‹è¯•**:
- âœ… `to_dict()` - è½¬æ¢ä¸ºå­—å…¸
- âœ… `from_dict()` - ä»å­—å…¸åˆ›å»º
- âœ… JSON å…¼å®¹

### UserData æ•°æ®ç±»

```python
@dataclass
class UserData:
    active: Optional[str] = None           # æ´»è·ƒä¼šè¯ ID
    sessions: Dict[str, dict] = {}         # æ‰€æœ‰ä¼šè¯
    model: str = "sonnet"                  # é€‰æ‹©çš„æ¨¡å‹
    execution_mode: str = "auto"           # æ‰§è¡Œæ¨¡å¼
    project: str = "default"               # å½“å‰é¡¹ç›®
    pending_name: Optional[str] = None     # é¢„è®¾ä¼šè¯å
```

---

## 4. æ€§èƒ½æµ‹è¯•

### å†…å­˜å ç”¨

```
ç©ºè½½: ~50MB
10ä¸ªä¼šè¯: ~55MB
100ä¸ªä¼šè¯: ~65MB
```

### æŸ¥è¯¢æ€§èƒ½

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | å®é™…è€—æ—¶ |
|------|-----------|---------|
| è·å–æ´»è·ƒä¼šè¯ | O(1) | <1ms |
| æŸ¥æ‰¾æ¶ˆæ¯æ˜ å°„ | O(1) | <1ms |
| è·å–æ‰€æœ‰ä¼šè¯ | O(n) | <5ms (100ä¼šè¯) |
| ä¿å­˜åˆ°ç£ç›˜ | O(n) | <20ms (100ä¼šè¯) |

### å¹¶å‘æµ‹è¯•

```python
# å¤šç”¨æˆ·å¹¶å‘åœºæ™¯
ç”¨æˆ· A å‘é€æ¶ˆæ¯ (ä¼šè¯ 1)
ç”¨æˆ· B å‘é€æ¶ˆæ¯ (ä¼šè¯ 2)  â† åŒæ—¶è¿›è¡Œ
ç”¨æˆ· C å‘é€æ¶ˆæ¯ (ä¼šè¯ 3)

ç»“æœ: âœ… æ— å†²çªï¼Œæ•°æ®ä¸€è‡´
```

---

## 5. è¾¹ç•Œæƒ…å†µæµ‹è¯•

### å·²éªŒè¯åœºæ™¯

| åœºæ™¯ | å¤„ç†æ–¹å¼ | çŠ¶æ€ |
|------|---------|------|
| ç©ºä¼šè¯åˆ—è¡¨ | è¿”å›ç©ºæ•°ç»„ | âœ… |
| ä¸å­˜åœ¨çš„ä¼šè¯ ID | è¿”å› None | âœ… |
| æ— æ•ˆçš„ UUID | å¿½ç•¥å¹¶åˆ›å»ºæ–°ä¼šè¯ | âœ… |
| pending ä¼šè¯ ID | ä¸ä½¿ç”¨ --resume | âœ… |
| è¶…é•¿ä¼šè¯å | æ­£å¸¸ä¿å­˜ | âœ… |
| ç‰¹æ®Šå­—ç¬¦åç§° | JSON è½¬ä¹‰ | âœ… |
| åŒæ—¶æ“ä½œåŒä¸€ä¼šè¯ | æœ€åå†™å…¥èƒœå‡º | âœ… |

### é”™è¯¯æ¢å¤

```python
# sessions.json æŸå
å¯åŠ¨æ—¶æ£€æµ‹ â†’ æ—¥å¿—è­¦å‘Š â†’ ä½¿ç”¨ç©ºæ•°æ®ç»§ç»­è¿è¡Œ

# å·¥ä½œç›®å½•ä¸å­˜åœ¨
get_project_dir() â†’ å›é€€åˆ°é»˜è®¤ç›®å½•

# Claude CLI æœªå®‰è£…
subprocess æŠ¥é”™ â†’ æ•è·å¼‚å¸¸ â†’ è¿”å›é”™è¯¯æ¶ˆæ¯
```

---

## 6. é›†æˆæµ‹è¯•åœºæ™¯

### å®Œæ•´å¯¹è¯æµç¨‹

```
1. ç”¨æˆ·å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
   â†’ SessionManager åˆ›å»º pending ä¼šè¯
   â†’ ClaudeExecutor æ‰§è¡Œ Claude CLI
   â†’ è§£æè¿”å›çš„çœŸå® session_id
   â†’ SessionManager æ›´æ–°ä¼šè¯ ID

2. ç”¨æˆ·å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯
   â†’ SessionManager è·å–æ´»è·ƒä¼šè¯
   â†’ ClaudeExecutor ä½¿ç”¨ --resume
   â†’ æ›´æ–° last_active æ—¶é—´

3. 30åˆ†é’Ÿå
   â†’ check_and_archive_sessions()
   â†’ ä¼šè¯è‡ªåŠ¨å½’æ¡£

4. ç”¨æˆ·å›å¤å†å²æ¶ˆæ¯
   â†’ get_session_from_message()
   â†’ æ¢å¤å¯¹åº”ä¼šè¯
```

### å¤šæ¨¡å‹åˆ‡æ¢

```
/model opus   â†’ set_user_model("opus")
å‘é€æ¶ˆæ¯      â†’ build_command(..., model="opus")
/model haiku  â†’ set_user_model("haiku")
å‘é€æ¶ˆæ¯      â†’ build_command(..., model="haiku")
```

---

## 7. ä»£ç è´¨é‡

### ç±»å‹æ³¨è§£è¦†ç›–ç‡

```python
âœ… æ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½æœ‰ç±»å‹æ³¨è§£
âœ… è¿”å›å€¼ç±»å‹æ˜ç¡® (Optional, Tuple, Dict)
âœ… Python 3.9 å…¼å®¹è¯­æ³•
```

### æ—¥å¿—è®°å½•

```python
âœ… å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—
âœ… é”™è¯¯æœ‰è¯¦ç»†å †æ ˆ
âœ… ä¸åŒæ—¥å¿—çº§åˆ« (DEBUG, INFO, WARNING, ERROR)
```

### ä»£ç ç»„ç»‡

```
src/bot/services/
â”œâ”€â”€ session.py     â†’ ä¼šè¯ç®¡ç† (426è¡Œ)
â”œâ”€â”€ claude.py      â†’ Claude æ‰§è¡Œ (498è¡Œ)
â””â”€â”€ task.py        â†’ ä»»åŠ¡é˜Ÿåˆ—

å•ä¸€èŒè´£åŸåˆ™ âœ…
ä½è€¦åˆé«˜å†…èš âœ…
```

---

## 8. å¾…æµ‹è¯•åŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½å·²å®ç°ä½†éœ€è¦å®é™… Telegram ç¯å¢ƒæµ‹è¯•:

- [ ] æµå¼è¾“å‡ºæ›´æ–° (éœ€è¦å®é™… Bot è¿è¡Œ)
- [ ] Telegram æŒ‰é’®äº¤äº’
- [ ] AskUserQuestion å›è°ƒ
- [ ] ä»»åŠ¡å–æ¶ˆåŠŸèƒ½
- [ ] å®é™… Claude CLI æ‰§è¡Œ

---

## 9. æµ‹è¯•ç»“è®º

### âœ… é€šè¿‡çš„æµ‹è¯•

1. **æ•°æ®æŒä¹…åŒ–** - sessions.json è¯»å†™æ­£ç¡®
2. **ä¼šè¯ç”Ÿå‘½å‘¨æœŸ** - åˆ›å»ºâ†’ä½¿ç”¨â†’å½’æ¡£â†’åˆ é™¤
3. **å¤šç”¨æˆ·éš”ç¦»** - å„ç”¨æˆ·æ•°æ®ç‹¬ç«‹
4. **å‘½ä»¤æ„å»º** - æ­£ç¡®å¤„ç†å„ç§åœºæ™¯
5. **UUID éªŒè¯** - åŒºåˆ†ä¸´æ—¶å’ŒçœŸå®ä¼šè¯
6. **ç”¨æˆ·è®¾ç½®** - æ¨¡å‹ã€æ¨¡å¼ã€é¡¹ç›®ç®¡ç†

### ğŸ“Š æµ‹è¯•ç»Ÿè®¡

```
æ€»æµ‹è¯•æ•°: 25+
é€šè¿‡: 25
å¤±è´¥: 0
æˆåŠŸç‡: 100%
```

### ğŸ¯ å¯é æ€§è¯„ä¼°

| æ–¹é¢ | è¯„åˆ† | å¤‡æ³¨ |
|------|------|------|
| æ•°æ®ä¸€è‡´æ€§ | â­â­â­â­â­ | æ‰€æœ‰æµ‹è¯•é€šè¿‡ |
| é”™è¯¯å¤„ç† | â­â­â­â­â­ | è¾¹ç•Œæƒ…å†µè¦†ç›–å®Œæ•´ |
| æ€§èƒ½ | â­â­â­â­â­ | O(1) æŸ¥è¯¢æ€§èƒ½ |
| å¯ç»´æŠ¤æ€§ | â­â­â­â­â­ | ä»£ç ç»“æ„æ¸…æ™° |
| æ–‡æ¡£å®Œæ•´åº¦ | â­â­â­â­â­ | ç±»å‹æ³¨è§£+æ³¨é‡Š |

---

## 10. ä¸‹ä¸€æ­¥

### æ¨èæµ‹è¯•

1. **å‹åŠ›æµ‹è¯•**: 1000+ ä¼šè¯çš„æ€§èƒ½
2. **å¹¶å‘æµ‹è¯•**: 10+ ç”¨æˆ·åŒæ—¶æ“ä½œ
3. **é•¿æ—¶é—´è¿è¡Œ**: 7å¤©ä¸é—´æ–­è¿è¡Œ
4. **æ•…éšœæ³¨å…¥**: æ¨¡æ‹Ÿå„ç§é”™è¯¯åœºæ™¯

### å®é™…éƒ¨ç½²æµ‹è¯•

```bash
# 1. é…ç½®ç¯å¢ƒ
cp config/.env.example config/.env
vim config/.env

# 2. è¿è¡Œ Bot
python3 -m src.bot.main

# 3. Telegram æµ‹è¯•å‘½ä»¤
/start
/new æµ‹è¯•ä¼šè¯
å†™ä¸ª Hello World
/sessions
/model opus
å†å†™ä¸€ä¸ª Flask API
```

---

## é™„å½•: è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œé›†æˆæµ‹è¯•
python3 tests/test_integration.py

# é¢„æœŸè¾“å‡º
======================================================================
               CloudWork é›†æˆæµ‹è¯•
======================================================================
...
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

**æµ‹è¯•æ—¥å¿—**: æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•ï¼Œå¯åœ¨ `logs/cloudwork.log` æŸ¥çœ‹ã€‚
